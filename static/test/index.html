<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <script src="./aframe.min.js"></script>
  <script src="./mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/mayognaise/aframe-touch-rotate-component/dist/aframe-touch-rotate-component.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }
    a-scene {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }
    #langMenu {
      position: fixed;
      background-color: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      padding: 10px;
      z-index: 1000;
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    #langMenu button {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }
    #langMenu button:hover {
      color: yellow;
    }
    .control-buttons {
      position: absolute;
      bottom: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      justify-content: center;
      z-index: 10;
      pointer-events: auto;
    }
    .button-row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      align-items: center;
    }
    .icon-button {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      box-shadow: none;
      background-color: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .icon-button img {
      width: 38px;
      height: 38px;
    }
    .icon-button-2 {
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background-color: transparent;
      border: none;
    }
    .icon-button-2 img {
      width: 120px;
      height: 38px;
    }
    .business-card-button {
      width: auto;
      height: auto;
    }
    .top-logo {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }
    .top-logo img {
      max-height: 40px;
      max-width: 200px;
      height: auto;
      width: auto;
      object-fit: contain;
      display: block;
    }
    .icon-button[disabled], .icon-button-2[disabled] {
      opacity: 0.4 !important;
      pointer-events: none;
    }
    #scanning-overlay {
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background: transparent;
      z-index: 2;
    }
    @media (min-aspect-ratio: 1/1) {
      #scanning-overlay .inner {
        width: 50vh;
        height: 50vh;
      }
    }
    @media (max-aspect-ratio: 1/1) {
      #scanning-overlay .inner {
        width: 80vw;
        height: 80vw;
      }
    }
    #scanning-overlay .inner {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      background:
        linear-gradient(to right, white 10px, transparent 10px) 0 0,
        linear-gradient(to right, white 10px, transparent 10px) 0 100%,
        linear-gradient(to left, white 10px, transparent 10px) 100% 0,
        linear-gradient(to left, white 10px, transparent 10px) 100% 100%,
        linear-gradient(to bottom, white 10px, transparent 10px) 0 0,
        linear-gradient(to bottom, white 10px, transparent 10px) 100% 0,
        linear-gradient(to top, white 10px, transparent 10px) 0 100%,
        linear-gradient(to top, white 10px, transparent 10px) 100% 100%;
      background-repeat: no-repeat;
      background-size: 40px 40px;
    }
    #scanning-overlay.hidden {
      display: none;
    }
    #scanning-overlay img {
      opacity: 0.6;
      width: 90%;
      align-self: center;
      display: none;
    }
    #scanning-overlay .inner .scanline {
      position: absolute;
      width: 100%;
      height: 10px;
      background: white;
      animation: move 2s linear infinite;
    }
    @keyframes move {
      0%, 100% { top: 0% }
      50% { top: calc(100% - 10px) }
    }
    #playButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      display: none;
    }
    #playButton img {
      width: 60px;
      height: 60px;
    }
    #musicButton {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 10;
    }

    #soundToggle {
      position: absolute;
      right: 20px;
      bottom: 90px;
      z-index: 11;
      display: none;
    }

    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 12px 18px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.3);
      cursor: pointer;
    }

    #toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      z-index: 2000;
      font-size: 14px;
      display: none;
      max-width: 80vw;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="top-logo">
    <img src="/icons/logo.png" alt="Logo" />
  </div>
  <div class="control-buttons">
    <div class="button-row">
      <button class="icon-button" id="formButton">
        <img src="/icons/avi.png" alt="Form">
      </button>
      <button class="icon-button" onclick="downloadCurrentVideo()">
        <img src="/icons/dan.png" alt="Download">
      </button>
      <button class="icon-button-2 business-card-button" id="cardButton">
        <img src="/icons/card.png" alt="Card">
      </button>
      <button class="icon-button" id="langButton">
        <img src="/icons/lang.png" alt="Lang">
      </button>
    </div>
  </div>
  <div id="langMenu">
    <button data-lang="en">English</button>
    <button data-lang="fr">Français</button>
    <button data-lang="de">Deutsch</button>
    <button data-lang="es">Español</button>
    <button data-lang="3d">3D Model</button>
  </div>
  <div id="scanning-overlay" class="">
    <div class="inner">
      <img id="dynamicTargetImg" alt="Target Image">
      <div class="scanline"></div>
    </div>
  <div id="noVideoMsg" style="display:none"></div>
  </div>
  <button class="icon-button" id="playButton" style="display: none;">
    <img src="/icons/play-icon.png" alt="Play Video">
  </button>
  <button class="icon-button" id="musicButton" style="display: none;">
    <img src="/icons/music.png" alt="Music">
  </button>
  <button class="icon-button" id="soundToggle" style="display: none;">
    <img src="/icons/sound.png" alt="Sound Toggle">
  </button>
  <button id="startButton">Start AR</button>
  <div id="toast"></div>
  <a-scene
    mindar-image="imageTargetSrc: target.mind; filterMinCF: 0.1; filterBeta: 10; warmupTolerance: 45; maxTrack: 10; uiScanning: #scanning-overlay;"
    embedded
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
  >
    <a-assets>
      <!-- keep a single placeholder video if needed by A-Frame, but we will create per-target video elements dynamically -->
      <video id="myVideo" loop playsinline webkit-playsinline crossorigin="anonymous" style="display:none"></video>
      <img id="videoThumbnail" src="thumbnail.jpg" alt="Thumbnail">
      <a-asset-item id="model1" src="model1.glb"></a-asset-item>
      <a-asset-item id="model2" src="model2.glb"></a-asset-item>
      <a-asset-item id="model3" src="model3.glb"></a-asset-item>
      <a-asset-item id="model4" src="model4.glb"></a-asset-item>
      <a-asset-item id="model5" src="model5.glb"></a-asset-item>
      <a-asset-item id="model6" src="model6.glb"></a-asset-item>
      <a-asset-item id="model7" src="model7.glb"></a-asset-item>
      <a-asset-item id="model8" src="model8.glb"></a-asset-item>
      <a-asset-item id="model9" src="model9.glb"></a-asset-item>
      <a-asset-item id="model10" src="model10.glb"></a-asset-item>
      <audio id="audio" src="audio1.mp3" preload="auto"></audio>
      <img id="extraImage" src="extra_image1.jpg" alt="Extra Image"></img>
    </a-assets>
    <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 10000;"></a-camera>
    <a-entity id="dynamic-targets"></a-entity>
    <a-light type="ambient" intensity="0.5"></a-light>
    <a-light type="directional" intensity="0.5" position="1 1 1"></a-light>
  </a-scene>
  <script>
    // چرخش سه‌بعدی مدل
    AFRAME.registerComponent('touch-rotate', {
      schema: { speed: { type: 'number', default: 1 } },
      init: function() {
        this.isDragging = false; this.previousX = 0; this.rotationY = 0;
        this.el.addEventListener('touchstart', evt => { this.isDragging = true; this.previousX = evt.touches[0].clientX; });
        this.el.addEventListener('touchmove', evt => {
          if (!this.isDragging) return;
          const currentX = evt.touches[0].clientX;
          const deltaX = currentX - this.previousX;
          this.rotationY -= deltaX * this.data.speed * 0.1;
          this.el.setAttribute('rotation', `0 ${this.rotationY} 0`);
          this.previousX = currentX;
        });
        this.el.addEventListener('touchend', () => { this.isDragging = false; });
      }
    });

    // متغیرها
    const MAX_TARGETS = 10;
    const DEFAULT_LANG = "fr";
    const VIDEO_EXTS = [".mp4", ".webm", ".mov"];
    let video = null;
    const sceneEl = document.querySelector("a-scene");
    const dynamicContainer = document.getElementById("dynamic-targets");
    let targetIndex = null;
    let hasPlayedOnce = false;
    let currentVideoPlane = null;
    let currentModel = null;
    let currentExtraImagePlane = null;
    let currentLang = DEFAULT_LANG;
    let isAudioPlaying = false;
    let businessLinks = [];
    let formLinks = [];
    const musicButton = document.getElementById("musicButton");
    const playButton = document.getElementById("playButton");
    const langButton = document.getElementById("langButton");
    const langMenu = document.getElementById("langMenu");
    const langButtons = langMenu.querySelectorAll("button");
    const formBtn = document.querySelector("#formButton");
    const cardBtn = document.querySelector("#cardButton");
    const scanningOverlay = document.getElementById("scanning-overlay");
    const dynamicTargetImg = document.getElementById("dynamicTargetImg");
    const audio = document.querySelector("#audio");
    const noVideoMsg = document.getElementById("noVideoMsg");
    const soundToggleBtn = document.getElementById("soundToggle");
    const startButton = document.getElementById("startButton");
    const toastEl = document.getElementById("toast");

    let userGestureUnlocked = false;
    let canAutoplayWithSound = false;

    // ایجاد ویدیوهای per target
    for (let i = 0; i < MAX_TARGETS; i++) {
      const v = document.createElement('video');
      v.setAttribute('id', `myVideo${i}`);
      v.setAttribute('playsinline', '');
      v.setAttribute('webkit-playsinline', '');
      v.setAttribute('loop', '');
      v.muted = true;
      v.crossOrigin = "anonymous";
      v.style.display = "none";
      document.body.appendChild(v);

      const entity = document.createElement("a-entity");
      entity.setAttribute("id", `target${i}`);
      entity.setAttribute("mindar-image-target", `targetIndex: ${i}`);
      dynamicContainer.appendChild(entity);
    }

    function getVideoElement(idx) { return document.querySelector(`#myVideo${idx}`); }
    function getCurrentVideo() { return (targetIndex === null) ? null : getVideoElement(targetIndex); }

    function updatePlaneSize(vidEl, idx) {
      const aspect = (vidEl.videoWidth && vidEl.videoHeight) ? (vidEl.videoWidth / vidEl.videoHeight) : 16/9;
      const fixedHeight = 1;
      const width = fixedHeight * aspect;
      const height = fixedHeight;
      const vPlane = document.querySelector(`#videoPlane${idx}`);
      if (vPlane) { vPlane.setAttribute("width", width); vPlane.setAttribute("height", height); vPlane.setAttribute("position", `0 0 0`); }
    }

    function normalizeUrl(url) {
      if (!url) return "";
      url = url.trim();
      if (!/^https?:\/\//i.test(url)) url = "https://" + url;
      return url;
    }

    async function fileExists(path) {
      try { const res = await fetch(path, { method: "HEAD" }); return res.ok; }
      catch { return false; }
    }

    function showToast(message, duration = 2000) {
      try {
        toastEl.textContent = message;
        toastEl.style.display = 'block';
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => { toastEl.style.display = 'none'; }, duration);
      } catch {}
    }

    async function showTargetContent(index, lang) {
      const entity = document.querySelector(`#target${index}`);
      let found = false;
      for (let ext of VIDEO_EXTS) {
        const path = `video${index + 1}-${lang}${ext}`;
        if (await fileExists(path)) {
          await setVideoSrc(path, index);
          if (!document.querySelector(`#videoPlane${index}`)) {
            currentVideoPlane = document.createElement("a-video");
            currentVideoPlane.setAttribute("id", `videoPlane${index}`);
            currentVideoPlane.setAttribute("src", `#myVideo${index}`);
            currentVideoPlane.setAttribute("position", "0 0 0");
            currentVideoPlane.setAttribute("rotation", "0 0 0");
            currentVideoPlane.setAttribute("visible", "false");
            currentVideoPlane.setAttribute("material", "side: double");
            entity.appendChild(currentVideoPlane);
          } else {
            currentVideoPlane = document.querySelector(`#videoPlane${index}`);
            currentVideoPlane.setAttribute("visible", "false");
          }
          video = getVideoElement(index);
          video.addEventListener("loadedmetadata", () => updatePlaneSize(video, index));
          found = true;
          noVideoMsg.style.display = "none";
          // Autoplay strategy:
          // If we unlocked via the Start button, try to play with sound; otherwise play muted with sound toggle visible
          const wantSound = !!canAutoplayWithSound;
          try { video.muted = !wantSound; } catch {}
          video.play().then(() => {
            if (currentVideoPlane) currentVideoPlane.setAttribute("visible", "true");
            soundToggleBtn.style.display = 'block';
            playButton.style.display = 'none';
          }).catch(() => {
            // If playback failed, fall back to muted
            try { video.muted = true; } catch {}
            video.play().then(() => {
              if (currentVideoPlane) currentVideoPlane.setAttribute("visible", "true");
              soundToggleBtn.style.display = 'block';
              playButton.style.display = 'none';
            }).catch(()=>{});
          });
          break;
        }
      }
      if (!found) {
        let curVid = getCurrentVideo();
        if (curVid) {
          try { curVid.pause(); } catch {}
          curVid.removeAttribute('src');
          curVid.load();
        }
        if (currentVideoPlane) currentVideoPlane.setAttribute("visible", "false");
        soundToggleBtn.style.display = 'none';
        playButton.style.display = "none";
        showToast("this language has no video");
      }
    }

    async function setVideoSrc(path, idx) {
      const vidEl = getVideoElement(idx);
      if (!vidEl) return;
      try { vidEl.pause(); } catch {}
      vidEl.src = path;
      vidEl.load();
      // playback happens in showTargetContent to centralize logic
    }

    // Sound toggle handler
    soundToggleBtn.addEventListener('click', async () => {
      const curVid = getCurrentVideo();
      if (!curVid) { showToast('First scan a target'); return; }
      try {
        curVid.muted = !curVid.muted;
        if (!curVid.muted) {
          canAutoplayWithSound = true;
          try { await curVid.play(); } catch {}
        }
      } catch {}
      soundToggleBtn.style.display = 'block';
    });
    

    musicButton.addEventListener("click", () => {
      if (targetIndex === null) {
        showToast("First scan a target");
        return;
      }
      if (!isAudioPlaying) {
        audio.src = `audio${targetIndex + 1}.mp3`;
        audio.play().catch(err => {});
        isAudioPlaying = true;
      } else {
        audio.pause();
        audio.currentTime = 0;
        isAudioPlaying = false;
      }
    });

    langButton.addEventListener("click", () => {
      langMenu.style.display = langMenu.style.display === "flex" ? "none" : "flex";
      if (langMenu.style.display === "flex") {
        const rect = langButton.getBoundingClientRect();
        langMenu.style.left = `${rect.left - 55}px`;
        langMenu.style.top = `${rect.top - 35 - langMenu.offsetHeight}px`;
      }
    });

    langButtons.forEach((btn) => {
      btn.addEventListener("click", async () => {
        const lang = btn.getAttribute("data-lang");
        if (targetIndex === null) {
          showToast("First scan a target");
          return;
        }
        currentLang = lang;
        await showTargetContent(targetIndex, lang);
        langMenu.style.display = "none";
        updateLinkButtons(targetIndex);
      });
    });

    function updateLinkButtons(index) {
      const formLink = formLinks[index] ? normalizeUrl(formLinks[index]) : "";
      const cardLink = businessLinks[index] ? normalizeUrl(businessLinks[index]) : "";
      formBtn.disabled = !formLink;
      formBtn.style.opacity = formLink ? 1 : 0.4;
      formBtn.onclick = formLink ? () => window.open(formLink, "_blank") : null;
      cardBtn.disabled = !cardLink;
      cardBtn.style.opacity = cardLink ? 1 : 0.4;
      cardBtn.onclick = cardLink ? () => window.open(cardLink, "_blank") : null;
    }

    window.downloadCurrentVideo = function () {
      const curVid = getCurrentVideo();
      if (curVid && curVid.src) {
        const link = document.createElement("a");
        link.href = curVid.src;
        link.download = curVid.src.split("/").pop();
        link.click();
      }
    };

    sceneEl.addEventListener("targetLost", () => {
      const curVid = getCurrentVideo();
      if (curVid) {
        try { curVid.pause(); } catch {}
        curVid.removeAttribute('src');
        curVid.load();
      }
      if (audio) {
        audio.pause();
        audio.currentTime = 0;
        isAudioPlaying = false;
      }
      ["videoPlane","extraImagePlane","model","fallbackCube"].forEach(name => {
        const el = document.querySelector(`#${name}${targetIndex}`);
        if (el) el.remove();
      });
      dynamicTargetImg.style.display = "none";
      targetIndex = null;
      langMenu.style.display = "none";
      musicButton.style.display = "none";
      playButton.style.display = "none";
      noVideoMsg.style.display = "none";
      soundToggleBtn.style.display = 'none';
      scanningOverlay.classList.remove("hidden");
      hasPlayedOnce = false;
      video = null;
      currentVideoPlane = null;
      currentExtraImagePlane = null;
      currentModel = null;
    });

    sceneEl.addEventListener("targetFound", async (e) => {
      let newTargetIndex = null;
      try {
        newTargetIndex = e.target?.getAttribute("mindar-image-target")?.targetIndex;
      } catch {}
      if (newTargetIndex == null) {
        newTargetIndex = e.detail?.anchor?.targetIndex ?? 0;
      }
      targetIndex = parseInt(newTargetIndex);
      dynamicTargetImg.style.display = "block";
      dynamicTargetImg.src = `image${targetIndex + 1}.jpg`;
      scanningOverlay.classList.add("hidden");
      await showTargetContent(targetIndex, currentLang);
      updateLinkButtons(targetIndex);
    });

    async function loadLinks() {
      try {
        const [businessText, formText] = await Promise.all([
          fetch(`business_links.txt`).then(res=>res.text()),
          fetch(`form_links.txt`).then(res=>res.text()),
        ]);
        try { businessLinks = JSON.parse(businessText); } catch { businessLinks = businessText.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
        try { formLinks = JSON.parse(formText); } catch { formLinks = formText.split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
      } catch (e) { businessLinks = []; formLinks = []; }
    }

    async function checkTargetFile() {
      try {
        const res = await fetch(`target.mind`, { method: "HEAD" });
        if (!res.ok) throw new Error("Target.mind couldn't find");
      } catch (err) {
        showToast('The target file (target.mind) could not be found.');
        scanningOverlay.classList.add("hidden");
      }
    }

    async function startMindAR() {
      try {
        const scene = document.querySelector('a-scene');
        const mindarSystem = scene?.systems?.['mindar-image-system'];
        if (mindarSystem && typeof mindarSystem.start === 'function') {
          await mindarSystem.start();
        }
      } catch {}
    }

    startButton.addEventListener('click', async () => {
      // Request camera + microphone in a single user gesture
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        stream.getTracks().forEach(t => t.stop());
        userGestureUnlocked = true;
        canAutoplayWithSound = true;
      } catch (e) {
        // Fallback to camera-only or muted autoplay
        try {
          const streamCam = await navigator.mediaDevices.getUserMedia({ video: true });
          streamCam.getTracks().forEach(t => t.stop());
        } catch {}
        userGestureUnlocked = true;
        canAutoplayWithSound = false;
      }
      startButton.style.display = 'none';
      await startMindAR();
    });

    window.addEventListener('load', async () => {
      await checkTargetFile();
      await loadLinks();
      // Show start button to request permissions in one gesture
      startButton.style.display = 'flex';
    });
  </script>
</body>
</html>
